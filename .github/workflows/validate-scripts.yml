name: ðŸ” Validate Scripts
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² Ð½Ð° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
# Script validation for syntax and security

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - 'configs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'configs/**'

jobs:
  shellcheck:
    name: ðŸš ShellCheck Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './scripts'
        format: gcc
        severity: warning
      env:
        SHELLCHECK_OPTS: -e SC1091 -e SC2034

    - name: ðŸ“‹ Check script permissions
      run: |
        echo "ðŸ” Checking script permissions..."
        find scripts/ -name "*.sh" -type f ! -executable -exec echo "âŒ Script not executable: {}" \;
        find scripts/ -name "*.sh" -type f ! -executable | wc -l | xargs -I {} test {} -eq 0

  syntax-check:
    name: ðŸ”§ Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸš Bash syntax check
      run: |
        echo "ðŸ” Checking bash script syntax..."
        exit_code=0
        for script in $(find scripts/ -name "*.sh" -type f); do
          echo "Checking: $script"
          if ! bash -n "$script"; then
            echo "âŒ Syntax error in: $script"
            exit_code=1
          else
            echo "âœ… $script - OK"
          fi
        done
        exit $exit_code

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”’ Install security tools
      run: |
        sudo apt-get update
        sudo apt-get install -y bandit
        
    - name: ðŸ” Scan for hardcoded secrets
      run: |
        echo "ðŸ” Scanning for potential secrets..."
        exit_code=0
        
        # Check for common secret patterns
        if grep -r -i -E "(password|passwd|pwd|secret|key|token|api_key)" scripts/ configs/ --include="*.sh" --include="*.conf" --include="*.yml" --include="*.yaml"; then
          echo "âš ï¸  Found potential secrets in files above"
          echo "Please review and ensure no actual secrets are committed"
          exit_code=1
        fi
        
        # Check for URLs with credentials
        if grep -r -E "https?://[^:]+:[^@]+@" scripts/ configs/ --include="*.sh" --include="*.conf"; then
          echo "âŒ Found URLs with embedded credentials"
          exit_code=1
        fi
        
        exit $exit_code

  validate-configs:
    name: âš™ï¸ Validate Configurations
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Validate YAML files
      run: |
        echo "ðŸ” Validating YAML configuration files..."
        exit_code=0
        
        for yaml_file in $(find configs/ -name "*.yml" -o -name "*.yaml" 2>/dev/null || true); do
          if [ -f "$yaml_file" ]; then
            echo "Validating: $yaml_file"
            if ! python3 -c "import yaml; yaml.safe_load(open('$yaml_file'))" 2>/dev/null; then
              echo "âŒ Invalid YAML: $yaml_file"
              exit_code=1
            else
              echo "âœ… $yaml_file - OK"
            fi
          fi
        done
        
        exit $exit_code

  test-dry-run:
    name: ðŸ§ª Dry Run Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ§ª Test script execution (dry-run)
      run: |
        echo "ðŸ§ª Testing script execution without making changes..."
        
        # Test main install script if it exists
        if [ -f "scripts/install.sh" ]; then
          echo "Testing install.sh..."
          # Add dry-run flag or test mode if supported
          # bash scripts/install.sh --dry-run || echo "âš ï¸  Dry-run not supported"
          
          # Check if script has basic safety checks
          if grep -q "set -e" scripts/install.sh; then
            echo "âœ… Script uses 'set -e' for error handling"
          else
            echo "âš ï¸  Script should use 'set -e' for better error handling"
          fi
        fi
        
        echo "âœ… Dry run tests completed"

  documentation-check:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Check documentation completeness
      run: |
        echo "ðŸ“š Checking documentation completeness..."
        
        missing_docs=0
        
        # Check if scripts have corresponding documentation
        for script in $(find scripts/ -name "*.sh" -type f); do
          script_name=$(basename "$script" .sh)
          if ! grep -q "$script_name" README.md Instructions/* 2>/dev/null; then
            echo "âš ï¸  Script $script_name not documented in README or Instructions"
            missing_docs=$((missing_docs + 1))
          fi
        done
        
        # Check for broken links in markdown files
        echo "ðŸ”— Checking for broken internal links..."
        for md_file in $(find . -name "*.md" -type f); do
          # Check for relative links that might be broken
          grep -E '\[.*\]\([^http].*\)' "$md_file" | while read -r line; do
            link=$(echo "$line" | sed 's/.*](\([^)]*\)).*/\1/')
            if [[ "$link" == *".md"* ]] && [ ! -f "$link" ]; then
              echo "âŒ Broken link in $md_file: $link"
            fi
          done
        done
        
        if [ $missing_docs -gt 0 ]; then
          echo "âš ï¸  Found $missing_docs undocumented scripts"
        else
          echo "âœ… All scripts are documented"
        fi

  notify-status:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [shellcheck, syntax-check, security-scan, validate-configs, test-dry-run, documentation-check]
    if: always()
    
    steps:
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸ“‹ Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ShellCheck | ${{ needs.shellcheck.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Syntax Check | ${{ needs.syntax-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Config Validation | ${{ needs.validate-configs.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dry Run Test | ${{ needs.test-dry-run.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation | ${{ needs.documentation-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY