name: ğŸ“š Update Documentation
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
# Automatic documentation updates

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'Instructions/**'
      - 'README.md'
  schedule:
    # Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
    # Weekly documentation update check
    - cron: '0 10 * * 1'
  workflow_dispatch:

jobs:
  update-readme:
    name: ğŸ“ Update README Badges
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ” Count scripts and configs
      id: count
      run: |
        script_count=$(find scripts/ -name "*.sh" -type f | wc -l)
        config_count=$(find configs/ -name "*" -type f | wc -l)
        instruction_count=$(find Instructions/ -name "*.md" -type f | wc -l)
        
        echo "scripts=$script_count" >> $GITHUB_OUTPUT
        echo "configs=$config_count" >> $GITHUB_OUTPUT
        echo "instructions=$instruction_count" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Found: $script_count scripts, $config_count configs, $instruction_count instructions"

    - name: ğŸ“ˆ Generate statistics
      run: |
        echo "## ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° / Project Statistics" > STATS.md
        echo "" >> STATS.md
        echo "- ğŸ”§ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹: **${{ steps.count.outputs.scripts }}**" >> STATS.md
        echo "- âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸: **${{ steps.count.outputs.configs }}**" >> STATS.md
        echo "- ğŸ“š Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸: **${{ steps.count.outputs.instructions }}**" >> STATS.md
        echo "- ğŸ“… ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: **$(date +'%Y-%m-%d %H:%M UTC')**" >> STATS.md
        echo "" >> STATS.md
        
        # Add supported technologies count
        tech_count=$(grep -o '!\[.*\](https://img.shields.io/badge/.*' README.md | wc -l)
        echo "- ğŸ› ï¸ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸: **$tech_count**" >> STATS.md

  check-external-links:
    name: ğŸ”— Check External Links
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”— Install link checker
      run: |
        npm install -g markdown-link-check
        
    - name: ğŸ” Check links in README
      run: |
        echo "ğŸ”— Checking external links in documentation..."
        
        # Create config for link checker
        cat > .markdown-link-check.json << EOF
        {
          "ignorePatterns": [
            {
              "pattern": "^http://localhost"
            },
            {
              "pattern": "^https://127.0.0.1"
            }
          ],
          "replacementPatterns": [],
          "httpHeaders": [
            {
              "urls": ["https://github.com/"],
              "headers": {
                "Accept": "text/html"
              }
            }
          ],
          "timeout": "10s",
          "retryOn429": true,
          "retryCount": 3,
          "fallbackRetryDelay": "30s"
        }
        EOF
        
        # Check all markdown files
        exit_code=0
        for file in README.md CONTRIBUTING.md CHANGELOG.md; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
            if ! markdown-link-check "$file" -c .markdown-link-check.json; then
              echo "âŒ Found broken links in: $file"
              exit_code=1
            else
              echo "âœ… $file - All links OK"
            fi
          fi
        done
        
        exit $exit_code

  validate-instructions:
    name: ğŸ“‹ Validate Instructions
    runs-on: ubuntu-24.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Test command examples
      run: |
        echo "ğŸ§ª Testing command examples in instructions..."
        
        # Extract and test basic commands from instructions
        exit_code=0
        
        # Test basic commands that should work on Ubuntu 24.04
        test_commands=(
          "which bash"
          "which python3"
          "which git"
          "lsb_release -rs"
          "uname -r"
        )
        
        for cmd in "${test_commands[@]}"; do
          echo "Testing: $cmd"
          if ! eval "$cmd" > /dev/null 2>&1; then
            echo "âŒ Command failed: $cmd"
            exit_code=1
          else
            echo "âœ… $cmd - OK"
          fi
        done
        
        # Check if we're on Ubuntu 24.04
        version=$(lsb_release -rs)
        if [ "$version" = "24.04" ]; then
          echo "âœ… Running on Ubuntu 24.04 as expected"
        else
          echo "âš ï¸  Running on Ubuntu $version, instructions target 24.04"
        fi
        
        exit $exit_code

  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Audit dependencies and URLs
      run: |
        echo "ğŸ”’ Performing security audit..."
        
        # Check for suspicious URLs or downloads
        echo "ğŸ” Checking for external downloads..."
        suspicious_patterns=(
          "curl.*http://[^s]"  # HTTP downloads (not HTTPS)
          "wget.*http://[^s]"  # HTTP downloads (not HTTPS)
          "download.*\.exe"    # Executable downloads
          "install.*\.deb.*http://"  # Insecure package downloads
        )
        
        exit_code=0
        for pattern in "${suspicious_patterns[@]}"; do
          if grep -r -E "$pattern" scripts/ Instructions/ 2>/dev/null; then
            echo "âš ï¸  Found potentially insecure pattern: $pattern"
            exit_code=1
          fi
        done
        
        # Check for recommended security practices
        echo "ğŸ” Checking security best practices..."
        if grep -r "set -e" scripts/ > /dev/null; then
          echo "âœ… Scripts use 'set -e' for error handling"
        else
          echo "âš ï¸  Consider adding 'set -e' to scripts"
        fi
        
        if grep -r "sudo.*curl\|sudo.*wget" scripts/ > /dev/null; then
          echo "âš ï¸  Found sudo with curl/wget - review for security"
          exit_code=1
        fi
        
        exit $exit_code

  auto-update-changelog:
    name: ğŸ“‹ Auto Update Changelog
    runs-on: ubuntu-latest
    needs: [update-readme, check-external-links, validate-instructions]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“‹ Generate changelog entry
      run: |
        echo "ğŸ“‹ Generating changelog entry for recent commits..."
        
        # Get commits since last tag or last 10 commits
        last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$last_tag" ]; then
          commits=$(git log ${last_tag}..HEAD --oneline --pretty=format:"- %s" 2>/dev/null || git log -10 --oneline --pretty=format:"- %s")
        else
          commits=$(git log -10 --oneline --pretty=format:"- %s")
        fi
        
        if [ -n "$commits" ]; then
          # Create temporary changelog entry
          date_today=$(date +%Y-%m-%d)
          
          echo "## [Unreleased] - $date_today" > TEMP_CHANGELOG.md
          echo "" >> TEMP_CHANGELOG.md
          echo "### ğŸ”„ Recent Changes / ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ" >> TEMP_CHANGELOG.md
          echo "$commits" >> TEMP_CHANGELOG.md
          echo "" >> TEMP_CHANGELOG.md
          
          # Merge with existing changelog
          if [ -f "CHANGELOG.md" ]; then
            tail -n +2 CHANGELOG.md >> TEMP_CHANGELOG.md
            mv TEMP_CHANGELOG.md CHANGELOG.md
          fi
          
          echo "âœ… Changelog updated with recent changes"
        fi

  commit-updates:
    name: ğŸ’¾ Commit Documentation Updates
    runs-on: ubuntu-latest
    needs: [auto-update-changelog]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: ğŸ’¾ Commit changes if any
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "ğŸ“š docs: auto-update documentation [skip ci]"
          git push
          echo "âœ… Documentation updated and committed"
        else
          echo "â„¹ï¸  No documentation changes to commit"
        fi